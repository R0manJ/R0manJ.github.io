<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh_cn">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linux," />










<meta name="description" content="Keepalive起初是为LVS设计的,专门用来监控LVS集群系统中各个服务节点的状态,后来又加入了VRRP的功能(Virtual Router Redundancy Protocol 虚拟路由器冗余协议),因此配合除了LVS服务外,也可以作为其他服务(nginx,haproxy)的高可用软件.  VRRP出现是为了解决静态路由出现的单点故障问题.  主要两大用户:healthcheck , fa">
<meta property="og:type" content="article">
<meta property="og:title" content="Keepalived高可用集群">
<meta property="og:url" content="http://github.com/r0manj/2017/11/16/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="R0hman の 实验室">
<meta property="og:description" content="Keepalive起初是为LVS设计的,专门用来监控LVS集群系统中各个服务节点的状态,后来又加入了VRRP的功能(Virtual Router Redundancy Protocol 虚拟路由器冗余协议),因此配合除了LVS服务外,也可以作为其他服务(nginx,haproxy)的高可用软件.  VRRP出现是为了解决静态路由出现的单点故障问题.  主要两大用户:healthcheck , fa">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-11-16T10:17:11.000Z">
<meta property="article:modified_time" content="2020-03-15T12:25:38.755Z">
<meta property="article:author" content="Rohman.Zhu">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://github.com/r0manj/2017/11/16/Keepalived高可用集群/"/>





  <title>Keepalived高可用集群 | R0hman の 实验室</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh_cn">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/r0manj" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">R0hman の 实验室</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-list"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br />
            
            Schedule
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://github.com/r0manj/2017/11/16/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Rohman.Zhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="R0hman の 实验室">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Keepalived高可用集群</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-16T18:17:11+08:00">
                2017-11-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Keepalive"><a href="#Keepalive" class="headerlink" title="Keepalive"></a>Keepalive</h1><p>起初是为LVS设计的,专门用来监控LVS集群系统中各个服务节点的状态,后来又加入了VRRP的功能(Virtual Router Redundancy Protocol 虚拟路由器冗余协议),因此配合除了LVS服务外,也可以作为其他服务(nginx,haproxy)的高可用软件.</p>
<blockquote>
<p>VRRP出现是为了解决静态路由出现的单点故障问题.</p>
</blockquote>
<p>主要两大用户:healthcheck , failover</p>
<h2 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h2><p>Virtual Router Redundacy Protocol,解决静态路由器的单点故障,VRRP时通过一种竞选协议机制来将故障路由器的任务给某台VRRP.</p>
<ul>
<li>VRRP是通过IP多播的方式实现通信</li>
<li>主发包,备接包,当备接不到主发的包的时候,就启动接管程序接管主的资源.</li>
</ul>
<h2 id="failover"><a href="#failover" class="headerlink" title="failover"></a>failover</h2><p>实现LB Master主机和 Backup 主机之间故障转移何自动切换.(这里针对有两个负载均衡)</p>
<h2 id="healthcheck"><a href="#healthcheck" class="headerlink" title="healthcheck"></a>healthcheck</h2><ol>
<li>keepalived.conf里面配置就可以实现LVS.</li>
<li>keepalive可以对LVS下面的集群节点做监控检查.</li>
</ol>
<p>负载均衡定期检查RSYNC的可用性决定是否给其分发请求.</p>
<h2 id="keepalived-故障切换转移原理"><a href="#keepalived-故障切换转移原理" class="headerlink" title="keepalived 故障切换转移原理"></a>keepalived 故障切换转移原理</h2><ol>
<li>在keepalived directors正常工作时,主Director节点会不断向被节点广播心跳消息,告诉备节点设备–主节点设备正常.</li>
<li>当主节点发生故障时,备节点就无法检测到主节点的心跳,今儿调用自身的接管程序,接管主节点的IP资源与服务.</li>
<li>当主节点恢复时,备节点会释放主节点故障时自身接管的IP资源与服务,恢复到原来的自身备用角色.</li>
</ol>
<h2 id="配置keepalive"><a href="#配置keepalive" class="headerlink" title="配置keepalive"></a>配置keepalive</h2><p>官网 <code>http:\\www.keepalived.org</code></p>
<p>这里用的是 1.2.16 的版本.</p>
<p>相关的配置可以用man keepalived.conf查看,这里只列出80%</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ln -s /user/src/kernel/2.6 /usr/src/linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 到keepalive的文件包里面</span></span><br><span class="line"><span class="comment"># ./configure</span></span><br><span class="line"><span class="comment"># 出现以下相关内容即可</span></span><br><span class="line">Use IPVS Framework  : Yes</span><br><span class="line">IPVS sync daemon support: Yes</span><br><span class="line">Use VRRP Framework : Yes</span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规范启动</span></span><br><span class="line"><span class="comment"># cp /usr/local/etc/rc.d/init.d/keepalived /etc/init.d/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置启动脚本参数</span></span><br><span class="line"><span class="comment"># cp /usr/local/etc/sysconfig/keepalived /etc/sysconfig/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建默认的keepalived配置文件路径</span></span><br><span class="line"><span class="comment"># mkdir /etc/keepalived</span></span><br><span class="line"><span class="comment"># cp /usr/local/etc/keepalived/keepalived.conf /etc/keepalived</span></span><br></pre></td></tr></table></figure>

<p>keepalived的配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">!Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">!全局变量</span><br><span class="line">!Comments start with ’#’ or ’!’ to the end of the line and can start anywhere in a line.</span><br><span class="line">!contains subblocks of Global definitions, Static routes, and Static rules</span><br><span class="line">global_defs&#123;</span><br><span class="line">    notification_email&#123;</span><br><span class="line">        !管理员邮箱</span><br><span class="line">        admin@example.com</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from admin@example.com</span><br><span class="line">    !邮箱服务器的地址设置</span><br><span class="line">    smtp_server xx.xx.xx.xx</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line"></span><br><span class="line">    !string,identifying the machine,(do not have to be hostname,default:localhostname)</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">!Static routes&#x2F;address&#x2F;rules</span><br><span class="line">!Keepalived can configure static addresses, routes, and rules. These addresses are NOT moved by vrrpd, they stay on the machine.  If you already  have  IPs and routes on your machines and your machines can ping each other, you don’t need this section.</span><br><span class="line"></span><br><span class="line">static_ipaddress&#123;</span><br><span class="line">    192.168.1.2&#x2F;24 dev eth0 scope global</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static_routes&#123;</span><br><span class="line">    192.168.1.1&#x2F;24 via 192.168.1.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static_rules&#123;</span><br><span class="line">    from 192.168.1.1&#x2F;24 table 1</span><br><span class="line">    to 192.168.1.1&#x2F;24 table 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">!Adds a scritpt to be executed periodically.Its exit code will be recorded for all VRRP instances which are monitoring it with non-zero weight.</span><br><span class="line">vrrp_script &lt;SCRIPT_NAME&gt;&#123;</span><br><span class="line">    !path of the script to execute</span><br><span class="line">    script &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</span><br><span class="line">    !seconds between script invocations,default 1 second</span><br><span class="line">    interval &lt;INTEGER&gt;</span><br><span class="line">    !seconds after which script is considered to have failed</span><br><span class="line">    timeout &lt;INTEGER&gt;</span><br><span class="line">    !adjust priority by this weight,default 2</span><br><span class="line">    weight &lt;INTEGER : -254..254&gt;</span><br><span class="line">    !required number of successes for OK transition</span><br><span class="line">    rise &lt;INTERGER&gt;</span><br><span class="line">    !required number of successes for KO transition</span><br><span class="line">    fall &lt;INTEGER&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">!describes the movable IP for each instance of a group in vrrp_sync_group.</span><br><span class="line">!Here are describes two IPs(on inside_network an on_outside_network)on machine &quot;my_hostname&quot;,!which belog to the group VG_1 and which will trasition together on any state change.</span><br><span class="line"></span><br><span class="line">vrrp_instance inside_network&#123;</span><br><span class="line">    !Initial state,MASTER | BACKUP</span><br><span class="line">    !As soon as the other machine(s) come up,</span><br><span class="line">    !an election will be held and the machine</span><br><span class="line">    !With the highest priority will become MASTER</span><br><span class="line">    !So the entry here do not matter a whole lot</span><br><span class="line">    state MASTER</span><br><span class="line"></span><br><span class="line">    !Interface for inside_network,bound by vrrp</span><br><span class="line">    interface eth0</span><br><span class="line"></span><br><span class="line">    !Use VRRP Virtual MAC.</span><br><span class="line">    use_vmac [&lt;VMAC_INTERFACE&gt;]</span><br><span class="line"></span><br><span class="line">    !Send&#x2F;Recv VRRP messages from base interface instea dof</span><br><span class="line">    vmac_xmit_base</span><br><span class="line"></span><br><span class="line">    !force instance to use IPv6(when mixed IPv4 and IPv6 config)</span><br><span class="line">    native_ipv6</span><br><span class="line"></span><br><span class="line">    !Ignore VRRP interface faults(default unset)</span><br><span class="line">    dont_track_primary</span><br><span class="line"></span><br><span class="line">    ! optional,monitor these as well</span><br><span class="line">    ! go to FAULT state if any of these go down</span><br><span class="line">    track_interface&#123;</span><br><span class="line">        eth0</span><br><span class="line">        eth1</span><br><span class="line">        eth2 weight &lt;-254..254&gt;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ! add a tracking script to the interface (&lt;SCRIPT_NAME&gt;is the name of the vrrp_script entry)</span><br><span class="line">    track_script&#123;</span><br><span class="line">        &lt;SCRIPT_NAME&gt;</span><br><span class="line">        &lt;SCRIPT_NAME&gt; weight &lt;-254..254&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    !Default IP for binding vrrpd is the primary IP on interface.If you want to hid the location of vrrpd, use this IP as src_addr for multicast or unicast vrrp packets.(Since it is multicast,vrrpd will get the reply packet no matter what src_addr is used).</span><br><span class="line">    !Optional</span><br><span class="line">    mcast_src_ip &lt;IPADDR&gt;</span><br><span class="line">    unicast_src_ip &lt;IPADDR&gt;</span><br><span class="line">    ! VRRP version to run on interface</span><br><span class="line">    version&lt;2 or 3&gt;</span><br><span class="line"></span><br><span class="line">    !addresses add|del on change to MASTER , to BACKUP.With the same entries on other machines, the opposite transition will be occurring.</span><br><span class="line">    virtual_ipaddress&#123;</span><br><span class="line">        &lt;IPADDR&gt;&#x2F;&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;</span><br><span class="line">        192.168.200.17&#x2F;24 dev eth1</span><br><span class="line">        192.168.200.18&#x2F;24 dev eth2 label eth2:1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # Note: authentication was removed from the VRRPv2 specification by RFC3768 in 2004.</span><br><span class="line">    #    Use of this option is non-compliant and can cause problems; avoid using if possible,</span><br><span class="line">    #   except when using unicast, where it can be helpful.</span><br><span class="line">    authentication &#123;</span><br><span class="line">        # Authentication block</span><br><span class="line">        # PASS||AH</span><br><span class="line">        # PASS - Simple password (suggested)</span><br><span class="line">        # AH - IPSEC (not recommended))</span><br><span class="line">        auth_type PASS</span><br><span class="line">        # Password for accessing vrrpd.</span><br><span class="line">        # should be the same on all machines.</span><br><span class="line">        # Only the first eight (8) characters are used.</span><br><span class="line">        auth_pass 1234</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要配置:</p>
<ul>
<li>从文档中可以看到,我们需要配置主要有全局参数(global_defs),email &amp; router_id</li>
<li>如果有需要定时执行的脚本,则配置vrrp_script 块, script位置,interval,weight</li>
<li>配置主机标签vrrp_instance ,里面设置state,网卡接口,主机ip,virtual_id,优先级priorioty,adver_int,authentication,为主机虚拟ip,检测脚本</li>
<li>用上一个步骤里面的虚拟IP配置虚拟服务器</li>
</ul>
<p>主:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">!Configuration file for keepalived</span><br><span class="line">global_defs&#123;</span><br><span class="line">    notification_email&#123;</span><br><span class="line">        zhur0ngjian@126.com</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from zhur0ngjian@126.com</span><br><span class="line">    smtp_server 127.0.0.1</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id MASTER_ROUTER</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance V1_1&#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    mcast_src_ip 172.16.177.150</span><br><span class="line">    priority 50</span><br><span class="line">    adver_int 1</span><br><span class="line">    authentication&#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass chtopnet</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress&#123;</span><br><span class="line">        10.0.1.1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.0.1.1 80&#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.177.150 80 &#123;</span><br><span class="line">        weight 3</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.177.151 80&#123;</span><br><span class="line">        weight 3</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>被:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">!Configuration file for keepalived</span><br><span class="line">global_defs&#123;</span><br><span class="line">    notification_email&#123;</span><br><span class="line">        zhur0ngjian@126.com</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from zhur0ngjian@126.com</span><br><span class="line">    smtp_server 127.0.0.1</span><br><span class="line">    smtp_connect_timeout 30</span><br><span class="line">    router_id BACKUP_ROUTER</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance V1_1&#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    mcast_src_ip 172.16.177.151</span><br><span class="line">    priority 50</span><br><span class="line">    adver_int 1</span><br><span class="line">    authentication&#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass chtopnet</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress&#123;</span><br><span class="line">        10.0.1.1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.0.1.1 80&#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 172.16.177.150 80 &#123;</span><br><span class="line">        weight 3</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 172.16.177.151 80&#123;</span><br><span class="line">        weight 3</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 10</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主备的配置文件需要注意:</p>
<ol>
<li>在vrrp_instance节点中,主备的实例名字可以不一样,但virtual_router_id必须一样.</li>
<li>virtual_router_id的作用是区分不同的vrrp组,因此在同一网段内,不同的vrrp组不能重复id.</li>
<li>一个 virtual_server节点中配置多个 real_server,需要注意 TCP_CHECK与’{‘ 之间的空格,如果没有空格,则从上往下数第二个real_server会识别不到.</li>
<li>VIP可以和主机真实IP地址不在同一个网段,但必须在环境中搭建VPN.</li>
</ol>
<p>启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># keeplived需要通过ip地址添加来启动服务</span><br><span class="line"># ip addr add 10.0.0.18&#x2F;24 dev eth0</span><br><span class="line"># &#x2F;etc&#x2F;init.d&#x2F;keepalived start</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对外提供服务的是VIP(virtual ip)</p>
</blockquote>
<h2 id="场景应用"><a href="#场景应用" class="headerlink" title="场景应用"></a>场景应用</h2><p>假设我们的集群架构中,有两台机器是作为LB存在,分别是LB1(主),LB2(备) ; 两台 LB 通过 <em>keepalive</em> 建立关系 , 当一台 <em>LB_挂了,立即启用 _备用LB</em> .</p>
<p>我用的 <em>load Balance</em> 软件是 Nginx , 所谓宕机就是 <em>Nginx</em> 和 <em>keepalive</em> 这两个服务停止了,然而当 <em>Nginx</em> 停止服务的时候 ,keepalive 是不能识别到的(Keepalive不会关闭,不会让 <em>备用LB</em> 接管 <em>主LB</em> 接受到的请求)</p>
<p>因此,我们要写一个监控Nginx状态的脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Monitoring Nginx status</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$(ps -ef|grep "nginx : master process"|grep -v grep)</span>"</span>==<span class="string">""</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    /application/nginx/sbin/nginx</span><br><span class="line">    sleep 5</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$(ps -ef|grep "nginx : master process"|grep -v grep)</span>"</span>==<span class="string">""</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">    killall keepalived</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>升级版:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/keepaalived/check_nginx.sh</span></span><br><span class="line">Count1=<span class="string">"netstat -antp |grep -v grep|grep nginx|wc -l"</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Count1</span> -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    /application/nginx/sbin/nginx</span><br><span class="line">    sleep 2</span><br><span class="line">    Count2=<span class="string">"netstat -antp|grep -v grep|grep nginx|wc -l"</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$Count2</span> -eq 0 ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        /etc/init.d/keepalived stop</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>这个脚本可以放到 <em>keepalived.conf</em> 里面 <em>vrrp_script</em> 节点中,这里可以每隔相应的时间执行一次脚本.</p>
<p>在工作时,keepalived根据用户设定的策略判断服务器上的程序是否正常运行,如果故障则将这台服务器从热备组移出.</p>
<p>在实例中重要参数: nopreempt , 当主LB挂了,备LB接管,主恢复,不自动接管</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/14/Linux%E4%B9%8Bkickstart%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88%E7%B3%BB%E7%BB%9F%E8%A3%85%E7%B3%BB%E7%BB%9F/" rel="next" title="Linux之kickstart无人值守系统装系统">
                <i class="fa fa-chevron-left"></i> Linux之kickstart无人值守系统装系统
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/17/Python%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="prev" title="Python学习笔记">
                Python学习笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Rohman.Zhu</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">185</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Keepalive"><span class="nav-number">1.</span> <span class="nav-text">Keepalive</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#VRRP"><span class="nav-number">1.1.</span> <span class="nav-text">VRRP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#failover"><span class="nav-number">1.2.</span> <span class="nav-text">failover</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#healthcheck"><span class="nav-number">1.3.</span> <span class="nav-text">healthcheck</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#keepalived-故障切换转移原理"><span class="nav-number">1.4.</span> <span class="nav-text">keepalived 故障切换转移原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置keepalive"><span class="nav-number">1.5.</span> <span class="nav-text">配置keepalive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#场景应用"><span class="nav-number">1.6.</span> <span class="nav-text">场景应用</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rohman.Zhu</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count"></span>
  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
